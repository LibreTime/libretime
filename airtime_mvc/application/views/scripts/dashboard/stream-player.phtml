<div id="content" class="jp-container">
    <h1><?php echo _("Live stream") ?></h1>
    <!-- <a id="popup-link" href="#"><?php echo _("Share") ?></a>  -->
    <?php $ids = Application_Model_StreamSetting::getEnabledStreamIds(); ?>
    <div class="jp-logo"><img id="logo-img" onload='resizeToMaxHeight(this, 40);' src="<?php echo $this->logo ?>" /></div>

    <div class="jp-stream stream-player-label">
        <div class="jp-stream-text"><?php echo _("Select stream:"); ?></div>
            
        <form id="form1" method="post" action="">
        <select id="combo-box">
            <?php
                foreach($ids as $id) {
                    $streamData = Application_Model_StreamSetting::getStreamData($id);
                    $url = "http://".$streamData["${id}_host"].":".$streamData["${id}_port"]."/".$streamData["${id}_mount"];
                    $type = $streamData["${id}_type"];
                    $serverType = $streamData["${id}_output"];
                    // if ($type == "ogg")
                    //     $type = "oga";
                    if ($serverType == "shoutcast"){
                        $url = $url + ";stream/1";
                    }

                    $label = "(".$streamData["${id}_host"].") ".$streamData["${id}_description"]." - ".$streamData["${id}_bitrate"]." kbit/s";
                    echo sprintf("<option class='stream' value='%s'>%s</option>", $url, $label);
                }
            ?>
        </select>
        </form>
    </div>

    <!-- <div id="jp_container_1" class="jp-audio">
        <div class="jp-type-single">
            <div id="jp_interface_1" class="jp-gui jp-interface">
                <ul class="jp-controls">
                    <li><a title="mute" tabindex="1" class="jp-mute" href="javascript:;"><?php echo _("mute") ?></a></li>
                    <li><a title="unmute" tabindex="1" class="jp-unmute" href="javascript:;"><?php echo _("unmute") ?></a></li>
                </ul>
                <div class="jp-volume-bar">
                    <div class="jp-volume-bar-value"></div>
                </div>
            </div>
        </div>
    </div> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.1/howler.js"></script>
    <!-- <script src="/js/libs/howler.js"></script> -->
    <script>
        // Pull first stream
        let streamURLs;
        <?php
            if (count($ids) > 0){
                $id = $ids[0];
                $streamData = Application_Model_StreamSetting::getStreamData($id);
                $url = "http://".$streamData["${id}_host"].":".$streamData["${id}_port"]."/".$streamData["${id}_mount"];
                $type = $streamData["${id}_type"];
                $serverType = $streamData["${id}_output"];
                // if ($type == "ogg")
                //     $type = "oga";
                if ($serverType == "shoutcast")
                    $url = $url + ";stream/1";
                echo "streamURLs = ['$url'];";
            }
        ?>

        var streamPlayer = new Howl({
            src: streamURLs,
            html5: true,
            format: ['ogg', 'mp3', 'opus', 'aac'],
            volume: 0.5
        });

        // Track changes in #combo-box
        var selectedStream = document.getElementById('combo-box');
        selectedStream.onchange = function() {
            sel = selectedStream.options[selectedStream.selectedIndex];
            // Check to see if new stream URL is different:
            // Do nothing if same, change to new stream if different.
            if (sel.value === streamPlayer.src) {
                return false
            } else {
                streamPlayer.stop();
                streamPlayer.src = sel.value;
                streamPlayer.play();
                console.log('Player changed to ' + sel.value);
            }
        }

        let playerMuted = false;
        function setHowlVolume(muted, volume){
            if (muted !== playerMuted) {
                streamPlayer.mute(muted);
            }
            if (volume !== streamPlayer.volume) {
                streamPlayer.volume(volume);
            }
        }

        // Button setup
        const setMuteBtn = document.querySelector('.jp-mute');
        const setUnmuteBtn = document.querySelector('.jp-unmute');

        setMuteBtn.addEventListener('click', setHowlVolume(true, playerVolume));
        setUnmuteBtn.addEventListener('click', setHowlVolume(false, playerVolume));

        // Copying stream URL to clipboard [WIP]
        const shareBtn = document.getElementById('popup-link');
        shareBtn.addEventListener('click', (event) => {
            console.log(shareBtn.value);
        });
        
    </script>
</div>